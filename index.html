<!DOCTYPE html>
<html>
<head>
    <title>Donation Platform</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .title {
            text-align: center;
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            text-decoration: none;
            cursor: pointer;
        }

        .donations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            grid-gap: 20px;
            margin-top: 20px;
        }

        .donation-card {
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f9f9f9;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="title">Create a Donation</h1>
        <form id="createDonationForm">
            <label class="form-label" for="name">Name</label>
            <input class="form-input" type="text" id="name" required>

            <label class="form-label" for="description">Description</label>
            <textarea class="form-input" id="description" required></textarea>

            <label class="form-label" for="startDate">Start Date</label>
            <input class="form-input" type="date" id="startDate" required>

            <label class="form-label" for="endDate">End Date</label>
            <input class="form-input" type="date" id="endDate" required>

            <label class="form-label" for="minDonation">Minimum Donation (ETH)</label>
            <input class="form-input" type="number" step="0.01" id="minDonation" required>

            <label class="form-label" for="maxDonation">Maximum Donation (ETH)</label>
            <input class="form-input" type="number" step="0.01" id="maxDonation" required>

            <button class="btn" type="submit">Create Donation</button>
        </form>

        <h1 class="title">Donations</h1>
        <div id="donationsGrid" class="donations-grid">
            <!-- Donations will be dynamically added here -->
        </div>

        <h1 class="title">Donate</h1>
        <form id="donateForm">
            <label class="form-label" for="donationId">Donation ID</label>
            <input class="form-input" type="number" id="donationId" required>

            <label class="form-label" for="donationAmount">Donation Amount (ETH)</label>
                        <input class="form-input" type="number" step="0.01" id="donationAmount" required>

            <button class="btn" type="submit">Donate</button>
        </form>
    </div>

    <script>
        // Contract address and ABI
        const contractAddress = "0x8827e9d2a110E090EA53B0A6eB2C374B318dE576";
        const contractABI = [
  {
    "inputs": [],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "donationId",
        "type": "uint256"
      },
      {
        "indexed": false,
        "internalType": "address",
        "name": "creator",
        "type": "address"
      }
    ],
    "name": "DonationAdded",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "donationId",
        "type": "uint256"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "amount",
        "type": "uint256"
      }
    ],
    "name": "DonationDistributed",
    "type": "event"
  },
  {
    "inputs": [
      {
        "internalType": "address[]",
        "name": "_addresses",
        "type": "address[]"
      },
      {
        "internalType": "string",
        "name": "_name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_description",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "_startDate",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "_endDate",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "_minDonation",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "_maxDonation",
        "type": "uint256"
      }
    ],
    "name": "addDonation",
    "outputs": [],
    "stateMutability": "payable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_donationId",
        "type": "uint256"
      }
    ],
    "name": "getDonation",
    "outputs": [
      {
        "components": [
          {
            "internalType": "address",
            "name": "creator",
            "type": "address"
          },
          {
            "internalType": "address[]",
            "name": "addresses",
            "type": "address[]"
          },
          {
            "internalType": "string",
            "name": "name",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "description",
            "type": "string"
          },
          {
            "internalType": "uint256",
            "name": "startDate",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "endDate",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "minDonation",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "maxDonation",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "totalDonations",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "distributedDonations",
            "type": "uint256"
          }
        ],
        "internalType": "struct DonationContract.Donation",
        "name": "",
        "type": "tuple"
      }
    ],
    "name": "getDonation",
    "outputs": [
      {
        "components": [
          {
            "internalType": "address",
            "name": "creator",
            "type": "address"
          },
          {
            "internalType": "address[]",
            "name": "addresses",
            "type": "address[]"
          },
          {
            "internalType": "string",
            "name": "name",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "description",
            "type": "string"
          },
          {
            "internalType": "uint256",
            "name": "startDate",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "endDate",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "minDonation",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "maxDonation",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "totalDonations",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "distributedDonations",
            "type": "uint256"
          }
        ],
        "internalType": "struct DonationContract.Donation",
        "name": "",
        "type": "tuple"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_donationId",
        "type": "uint256"
      }
    ],
    "name": "donate",
    "outputs": [],
    "stateMutability": "payable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_donationId",
        "type": "uint256"
      }
    ],
    "name": "distributeDonations",
    "outputs": [],
    "stateMutability": "external",
    "type": "function"
  }
];
        // Web3 instance
        let web3;

        // Contract instance
        let donationContract;

        // Initialize Web3 and contract instances
        async function initialize() {
            // Check if Web3 is already injected by the browser
            if (typeof window.ethereum !== "undefined") {
                web3 = new Web3(window.ethereum);
                await window.ethereum.enable();
            } else {
                alert("Please install MetaMask to use this dApp.");
                throw new Error("MetaMask not found");
            }

            // Create contract instance
            donationContract = new web3.eth.Contract(contractABI, contractAddress);

            // Fetch existing donations
            await fetchDonations();

            // Listen for events
            donationContract.events.DonationAdded({}, () => {
                fetchDonations();
            });

            donationContract.events.DonationDistributed({}, () => {
                fetchDonations();
            });
        }

        // Create a new donation
        async function createDonation(event) {
            event.preventDefault();

            const name = document.getElementById("name").value;
            const description = document.getElementById("description").value;
            const startDate = Math.floor(new Date(document.getElementById("startDate").value) / 1000);
            const endDate = Math.floor(new Date(document.getElementById("endDate").value) / 1000);
            const minDonation = web3.utils.toWei(document.getElementById("minDonation").value);
            const maxDonation = web3.utils.toWei(document.getElementById("maxDonation").value);

            try {
                const accounts = await web3.eth.getAccounts();
                const addresses = accounts.slice(0, 5); // Take only the first 5 addresses

                await donationContract.methods.addDonation(addresses, name, description, startDate, endDate, minDonation, maxDonation)
                    .send({ from: accounts[0], value: web3.utils.toWei("0.2", "ether") });

                document.getElementById("createDonationForm").reset();
            } catch (error) {
                console.error(error);
            }
        }

        // Fetch existing donations
async function fetchDonations() {
  try {
    const donationsGrid = document.getElementById("donationsGrid");
    donationsGrid.innerHTML = ""; // Clear the grid

    const donationsArray = await donationContract.methods.getDonations().call();

    for (let i = 0; i < donationsArray.length; i++) {
      const donationId = donationsArray[i];

      const donation = await donationContract.methods.getDonation(donationId).call();

      if (donation.endDate > Math.floor(Date.now() / 1000)) {
        // Only display active donations

        const donationCard = document.createElement("div");
        donationCard.className = "donation-card";

        const nameElement = document.createElement("h2");
        nameElement.textContent = donation.name;
        donationCard.appendChild(nameElement);

        const descriptionElement = document.createElement("p");
        descriptionElement.textContent = donation.description;
        donationCard.appendChild(descriptionElement);

        const creatorElement = document.createElement("p");
        creatorElement.textContent = "Creator: " + donation.creator;
        donationCard.appendChild(creatorElement);

        const startDateElement = document.createElement("p");
        startDateElement.textContent = "Start Date: " + new Date(donation.startDate * 1000).toLocaleString();
        donationCard.appendChild(startDateElement);

        const endDateElement = document.createElement("p");
        endDateElement.textContent = "End Date: " + new Date(donation.endDate * 1000).toLocaleString();
        donationCard.appendChild(endDateElement);

        const minDonationElement = document.createElement("p");
        minDonationElement.textContent = "Minimum Donation: " + donation.minDonation + " wei";
        donationCard.appendChild(minDonationElement);

        const maxDonationElement = document.createElement("p");
        maxDonationElement.textContent = "Maximum Donation: " + donation.maxDonation + " wei";
        donationCard.appendChild(maxDonationElement);

        const totalDonationsElement = document.createElement("p");
        totalDonationsElement.textContent = "Total Donations: " + donation.totalDonations + " wei";
        donationCard.appendChild(totalDonationsElement);

        const distributedDonationsElement = document.createElement("p");
        distributedDonationsElement.textContent = "Distributed Donations: " + donation.distributedDonations + " wei";
        donationCard.appendChild(distributedDonationsElement);

        if (donation.totalDonations > donation.distributedDonations) {
          const donateButton = document.createElement("button");
          donateButton.textContent = "Donate";
          donateButton.addEventListener("click", () => {
            showDonateModal(donationId);
          });
          donationCard.appendChild(donateButton);
        }

        donationsGrid.appendChild(donationCard);
      }
    }
  } catch (error) {
    console.error(error);
  }
}


        // Show donate modal
        function showDonateModal(donationId) {
            const modal = document.getElementById("donateModal");
            const donationIdInput = document.getElementById("donationIdInput");
            const donateForm = document.getElementById("donateForm");
            const donateAmountInput = document.getElementById("donateAmountInput");

            donationIdInput.value = donationId;
            donateForm.reset();
            modal.style.display = "block";
        }

        // Hide donate modal
        function hideDonateModal() {
            const modal = document.getElementById("donateModal");
            modal.style.display = "none";
        }

        // Donate to a specific donation
        async function donate(event) {
            event.preventDefault();

            const donationId = document.getElementById("donationIdInput").value;
            const donationAmount = web3.utils.toWei(document.getElementById("donateAmountInput").value);

            try {
                const accounts = await web3.eth.getAccounts();

                await donationContract.methods.donate(donationId)
                    .send({ from: accounts[0], value: donationAmount });

                hideDonateModal();
            } catch (error) {
                console.error(error);
            }
        }

        // Initialize the webpage
        initialize();

        // Event listeners
        document.getElementById("createDonationForm").addEventListener("submit", createDonation);
        document.getElementById("donateForm").addEventListener("submit", donate);
        document.getElementById("closeModalButton").addEventListener("click", hideDonateModal);
    </script>
    
</body>
</html>


