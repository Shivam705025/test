<!DOCTYPE html>
<html>
<head>
    <title>Bumboo Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f693; /* Yellow-themed background color */
        }

        .chat-container {
            max-width: 90%;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            background-color: #fff;
            overflow: hidden; /* To prevent horizontal overflow */
        }

        .chat-header {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 10px;
            background-color: #ffc107; /* Yellow header background color */
            color: #fff;
        }

        .chat-box {
            max-height: 80vh; /* Maximum height to screen size */
            overflow-y: auto;
            padding: 10px;
        }

        .chat-entry {
            margin-bottom: 20px; /* Increase spacing between messages */
        }

        .chat-entry-container {
            padding: 15px;
            border-radius: 20px;
            background-color: rgba(0, 0, 0, 0.5); /* Transparent black text box */
            color: #fff; /* Text color for chat entries */
            word-break: break-word; /* Wrap long messages */
        }

        .chat-entry .info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .chat-entry .sender-name {
            font-weight: bold;
            color: #ffc107; /* Yellow color for the sender's name */
        }

        .chat-entry .timestamp {
            font-size: 0.8rem;
            color: #bbb; /* Light gray color for the timestamp */
        }

        .input-box {
            display: flex;
            align-items: center;
            background-color: #fff;
            padding: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px 0 0 5px;
        }

        button {
            padding: 8px 15px;
            background-color: #ffc107; /* Yellow Send button */
            color: #fff;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
        }

        /* Media query for mobile responsiveness */
        @media (max-width: 600px) {
            .chat-container {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
    <div class="chat-header">Bumboo Chat</div>
    <div class="chat-box" id="chatBox"></div>
    <div class="input-box">
        <input type="text" id="messageInputChat" placeholder="Type your message...">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>
    <br>
<div class="input-box">
    <input type="text" id="nameInputChat" placeholder="Your Name">
    <input type="text" id="messageInputSetName" placeholder="Type your message...">
    <button onclick="setNameAndSendMessage()">Send</button>
</div>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script>
      const contractAddress = '0x3e7914b28bc81cb2785d0cd1aecf88a396d19f49'; // Replace with your smart contract address
const abi = [
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_data",
        "type": "string"
      }
    ],
    "name": "addString",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getRecentStrings",
    "outputs": [
      {
        "components": [
          {
            "internalType": "address",
            "name": "sender",
            "type": "address"
          },
          {
            "internalType": "string",
            "name": "name",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "data",
            "type": "string"
          },
          {
            "internalType": "uint256",
            "name": "timestamp",
            "type": "uint256"
          }
        ],
        "internalType": "struct RecentStrings.StringEntry[15]",
        "name": "",
        "type": "tuple[15]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_name",
        "type": "string"
      }
    ],
    "name": "setName",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "_addr",
        "type": "address"
      }
    ],
    "name": "getNameForAddress",
    "outputs": [
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];

   let contract; // Declare contract variable outside functions

      const web3 = new Web3(Web3.givenProvider);

async function connectWalletAndLoadChat() {
            try {
                await window.ethereum.enable();
                contract = new web3.eth.Contract(abi, contractAddress); // Initialize contract here
                await loadChat();
            } catch (error) {
                console.error('Error connecting to wallet:', error);
                alert('Failed to connect to your Ethereum wallet. Please make sure you have MetaMask or another compatible wallet installed and connected to Goerli Testnet.');
            }
        }


       async function sendMessage() {
    const name = "Your Name"; // Replace "Your Name" with the name of the sender (can be any string)
    const message = document.getElementById('messageInputChat').value;
    if (message.trim() === '') return;

    await connectWalletAndLoadChat(); // Ensure wallet is connected before sending the message

    try {
        const fromAddress = web3.givenProvider.selectedAddress;

        // Provide both "_name" and "_data" parameters when calling "addString"
        await contract.methods.addString(fromAddress, message).send({ from: fromAddress });
        document.getElementById('messageInputChat').value = '';
        loadChat();
    } catch (error) {
        console.error('Error sending message:', error);
    }
}

async function setNameAndSendMessage() {
    const name = document.getElementById('nameInputChat').value;
    if (name.trim() === '') return;

    await connectWalletAndLoadChat();

    try {
        const fromAddress = web3.givenProvider.selectedAddress;
        await contract.methods.setName(name).send({ from: fromAddress, value: web3.utils.toWei("1", "ether") });
        document.getElementById('nameInputChat').value = ''; // Clear the name input field after setting the name

        // Sending a message after setting the name (optional)
        const message = document.getElementById('messageInputSetName').value;
        if (message.trim() !== '') {
            await contract.methods.addString(name, message).send({ from: fromAddress });
            document.getElementById('messageInputSetName').value = ''; // Clear the message input field after sending the message
        }

        loadChat();
    } catch (error) {
        console.error('Error setting name or sending message:', error);
    }
}



// ... (existing code) ...

async function loadChat() {
    // ... (existing code) ...
    const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = '';

            const recentStrings = await contract.methods.getRecentStrings().call();
            
            // Sort the messages based on their timestamps in ascending order
            recentStrings.sort((a, b) => a.timestamp - b.timestamp);

            recentStrings.forEach(async stringEntry => {
                const sender = stringEntry.sender;
                const message = stringEntry.data;
                const timestamp = new Date(stringEntry.timestamp * 1000).toLocaleString();

                // Fetch the name from the contract for the sender's address
                const name = await contract.methods.getNameForAddress(sender).call();

                const chatEntry = document.createElement('div');
                // Use the name if available, or fallback to the sender's address in Ethereum address format
                const displayName = name.trim() !== '' ? name : (sender === web3.givenProvider.selectedAddress ? "Your Name" : formatAddress(sender));
                chatEntry.innerHTML = `<strong>${displayName}</strong> (${timestamp}): ${message}<br><br>`;
                chatBox.appendChild(chatEntry);
            });
        }

function formatAddress(address) {
    return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
}

document.addEventListener('DOMContentLoaded', async () => {
    if (window.ethereum && window.ethereum.isMetaMask) {
        // Check if the user has MetaMask or another compatible wallet
        await connectWalletAndLoadChat();
    } else {
        alert('Please install MetaMask or any other compatible Ethereum wallet to use this chat application.');
    }
});


    </script>
</body>
</html>
